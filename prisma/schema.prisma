// DefesaPix — Database Schema
// Engine: PostgreSQL via Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── AUTH ────────────────────────────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // hashed via bcryptjs
  phone         String?
  cpf           String?   @unique
  plan          Plan      @default(FREE)
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  casos         Caso[]
  documentos    Documento[]
  payments      Payment[]
  depoimentos   Depoimento[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ─── CASOS (Scam Cases) ──────────────────────────────────────────────────────

model Caso {
  id              String       @id @default(cuid())
  userId          String?
  // Victim Info
  nomeVitima      String
  emailVitima     String
  telefoneVitima  String?
  cpfVitima       String?
  // Scam Details
  tipoGolpe       TipoGolpe
  descricao       String       @db.Text
  valorPerdido    Decimal      @db.Decimal(12, 2)
  dataOcorrencia  DateTime
  bancoVitima     String?
  bancoDestinatario String?
  chavePixUsada   String?
  // Classification
  score           Int          @default(0)  // recovery probability 0-100
  prioridade      Prioridade   @default(MEDIA)
  status          StatusCaso   @default(ABERTO)
  // Tracking
  boRegistrado    Boolean      @default(false)
  medAcionado     Boolean      @default(false)
  bancioNotificado Boolean     @default(false)
  proconAcionado  Boolean      @default(false)
  // Metadata
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  documentos Documento[]
  acoes      AcaoCaso[]

  @@map("casos")
}

model AcaoCaso {
  id          String   @id @default(cuid())
  casoId      String
  descricao   String
  completado  Boolean  @default(false)
  dataLimite  DateTime?
  completadoEm DateTime?
  createdAt   DateTime @default(now())

  caso Caso @relation(fields: [casoId], references: [id], onDelete: Cascade)

  @@map("acoes_caso")
}

// ─── DOCUMENTOS ──────────────────────────────────────────────────────────────

model Documento {
  id          String        @id @default(cuid())
  userId      String?
  casoId      String?
  tipo        TipoDocumento
  titulo      String
  conteudo    String        @db.Text // JSON stringified template data
  pdfUrl      String?       // Stored in object storage
  pago        Boolean       @default(false)
  paymentId   String?
  createdAt   DateTime      @default(now())

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  caso    Caso?    @relation(fields: [casoId], references: [id], onDelete: SetNull)
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@map("documentos")
}

// ─── PAYMENTS ────────────────────────────────────────────────────────────────

model Payment {
  id          String        @id @default(cuid())
  userId      String?
  gatewayId   String        @unique  // Asaas payment ID
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("brl")
  status      PaymentStatus @default(PENDING)
  produto     ProdutoPago
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  documentos Documento[]

  @@map("payments")
}

// ─── BLOG ────────────────────────────────────────────────────────────────────

model Artigo {
  id           String   @id @default(cuid())
  slug         String   @unique
  titulo       String
  subtitulo    String?
  conteudo     String   @db.Text
  resumo       String   @db.Text
  categoria    String
  tags         String[] // PostgreSQL array
  autorNome    String
  autorAvatar  String?
  imagemCapa   String?
  tempoLeitura Int      @default(5) // minutes
  visualizacoes Int     @default(0)
  publicado    Boolean  @default(false)
  publishedAt  DateTime?
  seoTitle     String?
  seoDesc      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("artigos")
}

// ─── TESTIMONIALS ────────────────────────────────────────────────────────────

model Depoimento {
  id           String   @id @default(cuid())
  userId       String?
  nome         String
  cidade       String?
  tipoGolpe    TipoGolpe?
  valorRecuperado Decimal? @db.Decimal(12, 2)
  texto        String   @db.Text
  estrelas     Int      @default(5)
  aprovado     Boolean  @default(false)
  featured     Boolean  @default(false)
  createdAt    DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("depoimentos")
}

// ─── PARTNERS ────────────────────────────────────────────────────────────────

model Parceiro {
  id         String   @id @default(cuid())
  nome       String
  tipo       TipoParceiro
  oab        String?  // Numero OAB para advogados
  email      String   @unique
  telefone   String?
  whatsapp   String?
  cidade     String?
  estado     String?
  areaAtuacao String[]
  descricao  String?  @db.Text
  logoUrl    String?
  ativo      Boolean  @default(true)
  verificado Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("parceiros")
}

// ─── NEWSLETTER ──────────────────────────────────────────────────────────────

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())

  @@map("newsletter_subscribers")
}

// ─── ANALYTICS (Event Tracking) ──────────────────────────────────────────────

model Evento {
  id        String   @id @default(cuid())
  tipo      String   // diagnostico_completo, cta_clicado, pagamento_iniciado, etc.
  pagina    String?  // URL da página
  dados     String?  @db.Text // JSON com dados extras
  ip        String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())

  @@index([tipo, createdAt])
  @@index([createdAt])
  @@map("eventos")
}

// ─── ENUMS ───────────────────────────────────────────────────────────────────

enum Plan {
  FREE
  BASIC
  PRO
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

enum TipoGolpe {
  PIX
  WHATSAPP
  BOLETO
  ROMANCE
  EMPREGO
  INVESTIMENTO
  CLONE_APP
  PHISHING
  CARTAO
  CONSIGNADO
  OUTRO
}

enum Prioridade {
  ALTA
  MEDIA
  BAIXA
}

enum StatusCaso {
  ABERTO
  EM_ANDAMENTO
  RESOLVIDO
  ARQUIVADO
}

enum TipoDocumento {
  CONTESTACAO_MED
  BOLETIM_OCORRENCIA
  NOTIFICACAO_BANCO
  QUEIXA_BACEN
  NOTIFICACAO_PROCON
  PETICAO_JUDICIAL
  CHECKLIST
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ProdutoPago {
  BO_INDIVIDUAL
  MED
  NOTIFICACAO_BANCO
  PACOTE_EMERGENCIA
  REVISAO_ESPECIALISTA
  PLANO_MENSAL
}

enum TipoParceiro {
  ADVOGADO
  ESCRITORIO
  CONSULTORIA
  DELEGACIA_DIGITAL
}
